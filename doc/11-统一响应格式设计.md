# ç¬¬11è¯¾ï¼šç»Ÿä¸€å“åº”æ ¼å¼è®¾è®¡

## ğŸ¯ æœ¬è¯¾ç›®æ ‡

- ç†è§£ç»Ÿä¸€å“åº”æ ¼å¼çš„é‡è¦æ€§
- å­¦ä¹ æ³›å‹å“åº”ç±»çš„è®¾è®¡
- æŒæ¡æˆåŠŸå’Œå¤±è´¥å“åº”çš„å¤„ç†

---

## ğŸ“– ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€å“åº”æ ¼å¼ï¼Ÿ

### ä¸ç»Ÿä¸€çš„é—®é¢˜

```python
# æ¥å£1è¿”å›
{"id": 1, "name": "å°åŠ©æ‰‹"}

# æ¥å£2è¿”å›
{"data": {"id": 1}, "code": 0}

# æ¥å£3è¿”å›
{"result": {"id": 1}, "status": "ok"}

# å‰ç«¯éœ€è¦é’ˆå¯¹æ¯ä¸ªæ¥å£å†™ä¸åŒçš„å¤„ç†é€»è¾‘ ğŸ˜°
```

### ç»Ÿä¸€ä¹‹å

```python
# æ‰€æœ‰æ¥å£éƒ½è¿”å›
{
    "success": true/false,
    "data": {...},
    "error": null/{ "code": "...", "message": "..." }
}

# å‰ç«¯åªéœ€ä¸€å¥—å¤„ç†é€»è¾‘ ğŸ˜Š
```

---

## ğŸ” å“åº”æ ¼å¼è®¾è®¡

æŸ¥çœ‹ `app/schemas/response.py`ï¼š

### é”™è¯¯è¯¦æƒ…æ¨¡å¼

```python
from pydantic import BaseModel, Field

class ErrorDetail(BaseModel):
    """é”™è¯¯è¯¦æƒ…"""
    
    code: str = Field(description="é”™è¯¯ä»£ç ")
    message: str = Field(description="äººç±»å¯è¯»çš„é”™è¯¯æ¶ˆæ¯")
    details: Optional[dict] = Field(
        default=None,
        description="é¢å¤–çš„é”™è¯¯è¯¦æƒ…"
    )
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `code` | str | æœºå™¨å¯è¯»çš„é”™è¯¯ç ï¼Œå¦‚ "NOT_FOUND" |
| `message` | str | äººç±»å¯è¯»çš„é”™è¯¯æè¿° |
| `details` | dict | é¢å¤–ä¿¡æ¯ï¼Œå¦‚éªŒè¯é”™è¯¯çš„å­—æ®µè¯¦æƒ… |

### æ³›å‹å“åº”ç±»

```python
from typing import Generic, TypeVar

T = TypeVar("T")  # å®šä¹‰ç±»å‹å˜é‡

class APIResponse(BaseModel, Generic[T]):
    """
    é€šç”¨ API å“åº”åŒ…è£…å™¨
    ä½¿ç”¨æ³›å‹æ”¯æŒä»»æ„æ•°æ®ç±»å‹
    """

    success: bool = Field(description="è¯·æ±‚æ˜¯å¦æˆåŠŸ")
    data: Optional[T] = Field(
        default=None,
        description="å“åº”æ•°æ®ï¼ˆæˆåŠŸæ—¶å­˜åœ¨ï¼‰"
    )
    error: Optional[ErrorDetail] = Field(
        default=None,
        description="é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶å­˜åœ¨ï¼‰"
    )
```

---

## ğŸ“ å·¥å‚æ–¹æ³•è®¾è®¡

### æˆåŠŸå“åº”

```python
@classmethod
def ok(cls, data: T) -> "APIResponse[T]":
    """åˆ›å»ºæˆåŠŸçš„å“åº”"""
    return cls(success=True, data=data, error=None)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
# åœ¨è·¯ç”±ä¸­
return APIResponse.ok(AgentResponse.model_validate(agent))

# ç­‰ä»·äº
return APIResponse(
    success=True,
    data=AgentResponse.model_validate(agent),
    error=None
)
```

### å¤±è´¥å“åº”

```python
@classmethod
def fail(
    cls,
    code: str,
    message: str,
    details: Optional[dict] = None
) -> "APIResponse[None]":
    """åˆ›å»ºå¤±è´¥çš„å“åº”"""
    return cls(
        success=False,
        data=None,
        error=ErrorDetail(
            code=code, 
            message=message, 
            details=details
        )
    )
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
return APIResponse.fail(
    code="NOT_FOUND",
    message="Agent not found",
    details={"agent_id": 999}
)
```

---

## ğŸ”„ åœ¨è·¯ç”±ä¸­ä½¿ç”¨

### å£°æ˜å“åº”æ¨¡å‹

```python
from ..schemas.response import APIResponse
from ..schemas.agent import AgentResponse

@router.get(
    "",
    response_model=APIResponse[List[AgentResponse]],  # æ³›å‹ç±»å‹
)
async def get_agents(...) -> APIResponse[List[AgentResponse]]:
    agents = await service.get_agents()
    return APIResponse.ok([AgentResponse.model_validate(a) for a in agents])
```

### è¿”å›å•ä¸ªå¯¹è±¡

```python
@router.get(
    "/{agent_id}",
    response_model=APIResponse[AgentResponse],  # å•ä¸ªå¯¹è±¡
)
async def get_agent(agent_id: int, ...) -> APIResponse[AgentResponse]:
    agent = await service.get_agent(agent_id)
    return APIResponse.ok(AgentResponse.model_validate(agent))
```

### è¿”å›å¤æ‚ç»“æ„

```python
@router.post(
    "/conversations/{id}/messages",
    response_model=APIResponse[dict],  # å­—å…¸ç±»å‹
)
async def send_message(...) -> APIResponse[dict]:
    user_msg, ai_msg = await service.send_message(...)
    return APIResponse.ok({
        "user_message": MessageResponse.model_validate(user_msg).model_dump(),
        "assistant_message": MessageResponse.model_validate(ai_msg).model_dump(),
    })
```

---

## ğŸ“Š å“åº”ç¤ºä¾‹

### æˆåŠŸ - è·å–åˆ—è¡¨

```json
{
    "success": true,
    "data": [
        {
            "id": 1,
            "name": "å°åŠ©æ‰‹",
            "system_prompt": "You are helpful",
            "created_at": "2024-01-01T00:00:00"
        },
        {
            "id": 2,
            "name": "ä»£ç ä¸“å®¶",
            "system_prompt": "You are a coding expert",
            "created_at": "2024-01-02T00:00:00"
        }
    ],
    "error": null
}
```

### æˆåŠŸ - å•ä¸ªå¯¹è±¡

```json
{
    "success": true,
    "data": {
        "id": 1,
        "name": "å°åŠ©æ‰‹",
        "system_prompt": "You are helpful",
        "description": "é€šç”¨åŠ©æ‰‹",
        "created_at": "2024-01-01T00:00:00",
        "updated_at": "2024-01-01T00:00:00"
    },
    "error": null
}
```

### æˆåŠŸ - åˆ é™¤æ“ä½œ

```json
{
    "success": true,
    "data": {
        "deleted": true,
        "agent_id": 1
    },
    "error": null
}
```

### å¤±è´¥ - èµ„æºæœªæ‰¾åˆ°

```json
{
    "success": false,
    "data": null,
    "error": {
        "code": "NOT_FOUND",
        "message": "Agent with id 999 not found",
        "details": null
    }
}
```

### å¤±è´¥ - éªŒè¯é”™è¯¯

```json
{
    "success": false,
    "data": null,
    "error": {
        "code": "VALIDATION_ERROR",
        "message": "åç§°ä¸èƒ½ä¸ºç©º",
        "details": {
            "loc": ["body", "name"],
            "type": "value_error"
        }
    }
}
```

---

## ğŸ”§ å‰ç«¯å¤„ç†ç¤ºä¾‹

```javascript
// ç»Ÿä¸€çš„ API è°ƒç”¨å°è£…
async function apiCall(url, options = {}) {
    const response = await fetch(url, options);
    const result = await response.json();
    
    // ç»Ÿä¸€åˆ¤æ–­é€»è¾‘
    if (result.success) {
        return result.data;
    } else {
        // ç»Ÿä¸€é”™è¯¯å¤„ç†
        const error = new Error(result.error.message);
        error.code = result.error.code;
        error.details = result.error.details;
        throw error;
    }
}

// ä½¿ç”¨
try {
    const agents = await apiCall('/api/agents');
    console.log(agents);  // ç›´æ¥æ˜¯ data å†…å®¹
} catch (error) {
    console.error(error.code, error.message);
}
```

---

## ğŸ“‹ è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| ä¸€è‡´æ€§ | æ‰€æœ‰æ¥å£ä½¿ç”¨ç›¸åŒçš„å“åº”ç»“æ„ |
| å¯é¢„æµ‹ | å‰ç«¯å¯ä»¥ç»Ÿä¸€å¤„ç†å“åº” |
| è‡ªæè¿° | é”™è¯¯ä¿¡æ¯æ¸…æ™°ï¼ŒåŒ…å«é”™è¯¯ç  |
| å¯æ‰©å±• | details å­—æ®µå¯æ·»åŠ é¢å¤–ä¿¡æ¯ |

---

## ğŸ“ åŠ¨æ‰‹ç»ƒä¹ 

### ç»ƒä¹ ï¼šæ·»åŠ åˆ†é¡µå“åº”

```python
class PaginatedResponse(BaseModel, Generic[T]):
    """åˆ†é¡µå“åº”"""
    items: List[T]
    total: int
    page: int
    page_size: int
    
    @property
    def total_pages(self) -> int:
        return (self.total + self.page_size - 1) // self.page_size

# ä½¿ç”¨
@router.get("/agents", response_model=APIResponse[PaginatedResponse[AgentResponse]])
async def get_agents_paginated(page: int = 1, size: int = 20, ...):
    agents, total = await service.get_agents_paginated(page, size)
    return APIResponse.ok(PaginatedResponse(
        items=[AgentResponse.model_validate(a) for a in agents],
        total=total,
        page=page,
        page_size=size
    ))
```

---

## ğŸ“ æœ¬è¯¾å°ç»“

| çŸ¥è¯†ç‚¹ | æŒæ¡ç¨‹åº¦ |
|--------|---------|
| ç†è§£ç»Ÿä¸€å“åº”çš„é‡è¦æ€§ | â˜ |
| ä¼šè®¾è®¡æ³›å‹å“åº”ç±» | â˜ |
| ä¼šä½¿ç”¨å·¥å‚æ–¹æ³• | â˜ |
| ç†è§£å‰ç«¯ç»Ÿä¸€å¤„ç†çš„ä¾¿åˆ© | â˜ |
| ä¼šæ‰©å±•å“åº”æ ¼å¼ | â˜ |

---

## ğŸ”œ ä¸‹ä¸€è¯¾é¢„å‘Š

**ç¬¬12è¯¾ï¼šå¤§è¯­è¨€æ¨¡å‹ API åŸºç¡€** - å­¦ä¹ å¦‚ä½•è°ƒç”¨ LLM APIã€‚
