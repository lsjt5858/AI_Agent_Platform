# ç¬¬15è¯¾ï¼šé…ç½®ç®¡ç†æœ€ä½³å®è·µ

## ğŸ¯ æœ¬è¯¾ç›®æ ‡

- ç†è§£ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ç®¡ç†
- å­¦ä¹  pydantic-settings çš„ä½¿ç”¨
- æŒæ¡ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶çš„ç»“åˆ

---

## ğŸ“– ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ç®¡ç†ï¼Ÿ

### é—®é¢˜åœºæ™¯

```python
# âŒ ç¡¬ç¼–ç é…ç½® - ç³Ÿç³•çš„åšæ³•

# å®‰å…¨é—®é¢˜ï¼šAPI Key æš´éœ²åœ¨ä»£ç ä¸­
api_key = "sk-xxxxxxxxxxxx"

# ç¯å¢ƒé—®é¢˜ï¼šå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒæ··æ·†
database_url = "sqlite:///./dev.db"

# ä¿®æ”¹å›°éš¾ï¼šæ¯æ¬¡æ”¹é…ç½®éƒ½è¦æ”¹ä»£ç 
timeout = 30
```

### æ­£ç¡®åšæ³•

```python
# âœ… ä½¿ç”¨é…ç½®ç®¡ç†

# ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œå®‰å…¨
api_key = settings.llm_api_key  

# ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®
database_url = settings.database_url  

# é›†ä¸­ç®¡ç†ï¼Œæ˜“äºä¿®æ”¹
timeout = settings.llm_timeout  
```

---

## ğŸ” é¡¹ç›®é…ç½®å®ç°

æŸ¥çœ‹ `app/config.py`ï¼š

### ä½¿ç”¨ pydantic-settings

```python
from functools import lru_cache
from typing import Optional

from pydantic_settings import BaseSettings, SettingsConfigDict


class Settings(BaseSettings):
    """åº”ç”¨é…ç½®ç±»"""

    # é…ç½®åŠ è½½è¡Œä¸º
    model_config = SettingsConfigDict(
        env_file=".env",           # ä» .env æ–‡ä»¶åŠ è½½
        env_file_encoding="utf-8", # ç¼–ç 
        case_sensitive=False,      # ç¯å¢ƒå˜é‡ä¸åŒºåˆ†å¤§å°å†™
    )

    # åº”ç”¨é…ç½®
    app_name: str = "AI Agent Platform"
    debug: bool = False

    # æ•°æ®åº“é…ç½®
    database_url: str = "sqlite+aiosqlite:///./ai_agent.db"

    # LLM API é…ç½®
    llm_api_base_url: str = "https://dashscope.aliyuncs.com/compatible-mode/v1"
    llm_api_key: Optional[str] = None
    llm_model: str = "qwen-turbo"
    llm_timeout: int = 30

    # CORS é…ç½®
    cors_origins: list[str] = ["*"]
    cors_allow_credentials: bool = True
    cors_allow_methods: list[str] = ["*"]
    cors_allow_headers: list[str] = ["*"]
```

### é…ç½®å­—æ®µç±»å‹

| ç±»å‹ | ç¯å¢ƒå˜é‡å€¼ | Python å€¼ |
|------|-----------|----------|
| `str` | `"hello"` | `"hello"` |
| `int` | `"30"` | `30` |
| `bool` | `"true"/"1"/"yes"` | `True` |
| `list[str]` | `"a,b,c"` æˆ– `'["a","b","c"]'` | `["a","b","c"]` |

### å•ä¾‹æ¨¡å¼

```python
@lru_cache
def get_settings() -> Settings:
    """è·å–é…ç½®å®ä¾‹ï¼ˆç¼“å­˜ï¼‰"""
    return Settings()
```

**ä½¿ç”¨ `@lru_cache` çš„å¥½å¤„**ï¼š
- é…ç½®åªåŠ è½½ä¸€æ¬¡
- åç»­è°ƒç”¨è¿”å›ç¼“å­˜ç»“æœ
- èŠ‚çœèµ„æº

---

## ğŸ“ ç¯å¢ƒå˜é‡æ–‡ä»¶

### .env.exampleï¼ˆæ¨¡æ¿æ–‡ä»¶ï¼Œæäº¤åˆ° Gitï¼‰

```env
# åº”ç”¨é…ç½®
APP_NAME=AI Agent Platform
DEBUG=false

# æ•°æ®åº“
DATABASE_URL=sqlite+aiosqlite:///./ai_agent.db

# LLM API é…ç½®
LLM_API_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_API_KEY=your-api-key-here
LLM_MODEL=qwen-turbo
LLM_TIMEOUT=30

# CORS é…ç½®ï¼ˆå¯é€‰ï¼‰
# CORS_ORIGINS=["http://localhost:3000"]
```

### .envï¼ˆå®é™…é…ç½®ï¼Œä¸æäº¤åˆ° Gitï¼‰

```env
LLM_API_KEY=sk-xxxxxxxxxxxxxxxx
DEBUG=true
```

### .gitignore

```gitignore
# ç¯å¢ƒå˜é‡ï¼ˆåŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰
.env
.env.local
.env.*.local
```

---

## ğŸ”§ é…ç½®ä¼˜å…ˆçº§

é…ç½®å€¼çš„æ¥æºä¼˜å…ˆçº§ï¼š

```
1. ç¯å¢ƒå˜é‡ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
   â””â”€â”€ export LLM_API_KEY=xxx
   
2. .env æ–‡ä»¶
   â””â”€â”€ LLM_API_KEY=xxx
   
3. Settings ç±»çš„é»˜è®¤å€¼ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰
   â””â”€â”€ llm_api_key: Optional[str] = None
```

---

## ğŸ“Š åœ¨ä»£ç ä¸­ä½¿ç”¨é…ç½®

### å¯¼å…¥é…ç½®

```python
from .config import get_settings

settings = get_settings()

# ä½¿ç”¨é…ç½®å€¼
api_key = settings.llm_api_key
timeout = settings.llm_timeout
```

### åœ¨ä¾èµ–æ³¨å…¥ä¸­ä½¿ç”¨

```python
from fastapi import Depends

def get_llm_service(
    settings: Settings = Depends(get_settings)
) -> LLMService:
    return LLMService(
        api_base_url=settings.llm_api_base_url,
        api_key=settings.llm_api_key,
        model=settings.llm_model,
        timeout=settings.llm_timeout
    )
```

### åœ¨ main.py ä¸­ä½¿ç”¨

```python
from .config import get_settings

settings = get_settings()

app = FastAPI(
    title=settings.app_name,
    debug=settings.debug,
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=settings.cors_allow_credentials,
    allow_methods=settings.cors_allow_methods,
    allow_headers=settings.cors_allow_headers,
)
```

---

## ğŸŒ å¤šç¯å¢ƒé…ç½®

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¸åŒçš„ .env æ–‡ä»¶

```bash
# å¼€å‘ç¯å¢ƒ
cp .env.development .env

# ç”Ÿäº§ç¯å¢ƒ
cp .env.production .env
```

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡åˆ‡æ¢

```python
import os

class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=f".env.{os.getenv('ENV', 'development')}",
    )
```

```bash
# å¼€å‘ç¯å¢ƒ
ENV=development uvicorn app.main:app

# ç”Ÿäº§ç¯å¢ƒ
ENV=production uvicorn app.main:app
```

---

## ğŸ“‹ é…ç½®æœ€ä½³å®è·µ

| å®è·µ | è¯´æ˜ |
|------|------|
| æ•æ„Ÿä¿¡æ¯ç”¨ç¯å¢ƒå˜é‡ | API Keyã€å¯†ç ç­‰ä¸èƒ½ç¡¬ç¼–ç  |
| æä¾›é»˜è®¤å€¼ | éæ•æ„Ÿé…ç½®æä¾›åˆç†é»˜è®¤å€¼ |
| ç±»å‹æ ‡æ³¨ | ä½¿ç”¨ Python ç±»å‹æ³¨è§£ |
| æä¾›ç¤ºä¾‹æ–‡ä»¶ | `.env.example` å¸®åŠ©æ–°æˆå‘˜é…ç½® |
| ä½¿ç”¨ç¼“å­˜ | `@lru_cache` é¿å…é‡å¤åŠ è½½ |
| éªŒè¯é…ç½® | å¯åŠ¨æ—¶æ£€æŸ¥å¿…éœ€é…ç½®æ˜¯å¦å­˜åœ¨ |

---

## ğŸ“ åŠ¨æ‰‹ç»ƒä¹ 

### ç»ƒä¹ ï¼šæ·»åŠ é…ç½®éªŒè¯

```python
from pydantic import field_validator

class Settings(BaseSettings):
    llm_api_key: Optional[str] = None
    
    @field_validator("llm_api_key")
    @classmethod
    def validate_api_key(cls, v):
        if v is None:
            import warnings
            warnings.warn(
                "LLM_API_KEY not set, LLM features will not work"
            )
        return v
```

### ç»ƒä¹ ï¼šæ·»åŠ å¯åŠ¨æ£€æŸ¥

```python
# main.py

@asynccontextmanager
async def lifespan(app: FastAPI):
    # æ£€æŸ¥å¿…éœ€é…ç½®
    settings = get_settings()
    if not settings.llm_api_key:
        import logging
        logging.warning("âš ï¸ LLM_API_KEY not configured!")
    
    await init_db()
    yield
```

---

## ğŸ“ æœ¬è¯¾å°ç»“

| çŸ¥è¯†ç‚¹ | æŒæ¡ç¨‹åº¦ |
|--------|---------|
| ç†è§£é…ç½®ç®¡ç†çš„é‡è¦æ€§ | â˜ |
| ä¼šä½¿ç”¨ pydantic-settings | â˜ |
| ç†è§£ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§ | â˜ |
| ä¼šé…ç½® .env æ–‡ä»¶ | â˜ |
| ç†è§£é…ç½®å®‰å…¨æœ€ä½³å®è·µ | â˜ |

---

## ğŸ”œ ä¸‹ä¸€è¯¾é¢„å‘Š

**ç¬¬16è¯¾ï¼šé¡¹ç›®æ¶æ„å®Œæ•´å›é¡¾** - ç»¼åˆå›é¡¾é¡¹ç›®æ¶æ„ï¼Œæ€»ç»“æ‰€å­¦çŸ¥è¯†ã€‚
