# ç¬¬08è¯¾ï¼šä¾èµ–æ³¨å…¥è¯¦è§£

## ğŸ¯ æœ¬è¯¾ç›®æ ‡

- æ·±å…¥ç†è§£ FastAPI ä¾èµ–æ³¨å…¥æœºåˆ¶
- æŒæ¡ä¾èµ–é“¾çš„è®¾è®¡æ–¹æ³•
- å­¦ä¹ ä¾èµ–çš„å¤ç”¨å’Œç»„åˆ

---

## ğŸ“– ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ

ä¾èµ–æ³¨å…¥ï¼ˆDependency Injection, DIï¼‰æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå°†ç»„ä»¶çš„ä¾èµ–ç”±å¤–éƒ¨æä¾›è€Œéå†…éƒ¨åˆ›å»ºã€‚

### å¯¹æ¯”ç¤ºä¾‹

**ä¸ä½¿ç”¨ä¾èµ–æ³¨å…¥**ï¼š
```python
@router.get("/agents")
async def get_agents():
    # åœ¨å‡½æ•°å†…éƒ¨åˆ›å»ºä¾èµ– - è€¦åˆåº¦é«˜
    session = create_session()
    service = AgentService(session)
    return await service.get_agents()
```

**ä½¿ç”¨ä¾èµ–æ³¨å…¥**ï¼š
```python
@router.get("/agents")
async def get_agents(
    service: AgentService = Depends(get_service)
):
    # ä¾èµ–ç”±å¤–éƒ¨æ³¨å…¥ - è§£è€¦
    return await service.get_agents()
```

### ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| è§£è€¦ | ç»„ä»¶ä¸éœ€è¦çŸ¥é“ä¾èµ–å¦‚ä½•åˆ›å»º |
| å¯æµ‹è¯• | å®¹æ˜“æ›¿æ¢ä¸º Mock å¯¹è±¡ |
| å¤ç”¨ | ä¾èµ–å¯ä»¥è¢«å¤šä¸ªè·¯ç”±å…±äº« |
| çµæ´» | è¿è¡Œæ—¶å†³å®šä½¿ç”¨å“ªä¸ªå®ç° |

---

## ğŸ” é¡¹ç›®ä¸­çš„ä¾èµ–é“¾

### ä¾èµ–å…³ç³»å›¾

```
Router å‡½æ•°å‚æ•°
      â”‚
      â”‚ Depends(get_service)
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   get_service   â”‚  â† è·å– Service
â”‚   (ä¾èµ–å‡½æ•°)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Depends(get_db)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     get_db      â”‚  â† è·å–æ•°æ®åº“ä¼šè¯
â”‚   (ä¾èµ–å‡½æ•°)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ åˆ›å»º AsyncSession
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  async_session  â”‚  â† æ•°æ®åº“ä¼šè¯å·¥å‚
â”‚     _maker      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ä¾èµ–å‡½æ•°å®ç°

### ç¬¬ä¸€å±‚ï¼šæ•°æ®åº“ä¼šè¯

```python
# app/database.py

async def get_db() -> AsyncSession:
    """æä¾›æ•°æ®åº“ä¼šè¯çš„ä¾èµ–"""
    async with async_session_maker() as session:
        try:
            yield session
            await session.commit()
        except Exception:
            await session.rollback()
            raise
        finally:
            await session.close()
```

**è¦ç‚¹**ï¼š
- `yield` ä½¿å‡½æ•°æˆä¸º**ç”Ÿæˆå™¨ä¾èµ–**
- `yield` ä¹‹å‰çš„ä»£ç åœ¨è·¯ç”±æ‰§è¡Œå‰è¿è¡Œ
- `yield` ä¹‹åçš„ä»£ç åœ¨è·¯ç”±æ‰§è¡Œåè¿è¡Œ

### ç¬¬äºŒå±‚ï¼šService å®ä¾‹

```python
# app/routers/agents.py

async def get_service(
    session: AsyncSession = Depends(get_db)
) -> AgentService:
    """è·å– AgentService å®ä¾‹"""
    return get_agent_service(session)
```

**è¦ç‚¹**ï¼š
- ä¾èµ–å‡½æ•°å¯ä»¥æœ‰è‡ªå·±çš„ä¾èµ–ï¼ˆ`Depends(get_db)`ï¼‰
- å½¢æˆä¾èµ–é“¾

### ç¬¬ä¸‰å±‚ï¼šåœ¨è·¯ç”±ä¸­ä½¿ç”¨

```python
@router.get("/agents")
async def get_agents(
    service: AgentService = Depends(get_service)
) -> APIResponse[List[AgentResponse]]:
    agents = await service.get_agents()
    return APIResponse.ok([AgentResponse.model_validate(a) for a in agents])
```

---

## ğŸ”„ ä¾èµ–ç”Ÿå‘½å‘¨æœŸ

### è¯·æ±‚å¤„ç†æµç¨‹

```
å®¢æˆ·ç«¯è¯·æ±‚
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FastAPI æ¡†æ¶                       â”‚
â”‚                                                    â”‚
â”‚  1. è§£æä¾èµ–é“¾                                      â”‚
â”‚     get_agents                                     â”‚
â”‚       â””â”€â”€ get_service                              â”‚
â”‚             â””â”€â”€ get_db                             â”‚
â”‚                                                    â”‚
â”‚  2. ä»åº•å‘ä¸Šåˆ›å»ºä¾èµ–                                 â”‚
â”‚     get_db() â†’ yield session                       â”‚
â”‚     get_service(session) â†’ return AgentService     â”‚
â”‚                                                    â”‚
â”‚  3. è°ƒç”¨è·¯ç”±å‡½æ•°                                    â”‚
â”‚     get_agents(service) â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘              â”‚
â”‚                                                    â”‚
â”‚  4. æ¸…ç†ä¾èµ–ï¼ˆé€†åºï¼‰                                â”‚
â”‚     get_db() â†’ commit/rollback, close              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
è¿”å›å“åº”
```

---

## ğŸ“Š Depends çš„é«˜çº§ç”¨æ³•

### 1. ç±»ä½œä¾èµ–

```python
class CommonQueryParams:
    """é€šç”¨æŸ¥è¯¢å‚æ•°"""
    def __init__(
        self,
        skip: int = 0,
        limit: int = 100,
        search: str | None = None
    ):
        self.skip = skip
        self.limit = limit
        self.search = search

@router.get("/agents")
async def get_agents(
    params: CommonQueryParams = Depends()
):
    # params.skip, params.limit, params.search
    ...
```

### 2. ä¾èµ–è¿”å›å¤šä¸ªå€¼

```python
async def get_current_user_and_agent(
    user_id: int,
    agent_id: int,
    session: AsyncSession = Depends(get_db)
) -> tuple[User, Agent]:
    user = await session.get(User, user_id)
    agent = await session.get(Agent, agent_id)
    return user, agent

@router.get("/check")
async def check_access(
    user_agent: tuple = Depends(get_current_user_and_agent)
):
    user, agent = user_agent
    ...
```

### 3. å¯é€‰ä¾èµ–

```python
async def get_optional_token(
    authorization: str | None = Header(default=None)
) -> str | None:
    return authorization

@router.get("/public")
async def public_endpoint(
    token: str | None = Depends(get_optional_token)
):
    if token:
        # å·²è®¤è¯
        ...
    else:
        # æœªè®¤è¯
        ...
```

---

## ğŸ”§ é¡¹ç›®ä¾èµ–æ¨¡å¼æ€»ç»“

### è·¯ç”±æ–‡ä»¶çš„æ ‡å‡†æ¨¡å¼

```python
# routers/agents.py

from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession

from ..database import get_db
from ..services.agent import AgentService, get_agent_service

router = APIRouter(prefix="/agents", tags=["æ™ºèƒ½ä½“ç®¡ç†"])

# å®šä¹‰è·å– Service çš„ä¾èµ–
async def get_service(
    session: AsyncSession = Depends(get_db)
) -> AgentService:
    return get_agent_service(session)

# åœ¨è·¯ç”±ä¸­ä½¿ç”¨
@router.post("")
async def create_agent(
    data: AgentCreate,
    service: AgentService = Depends(get_service)
):
    agent = await service.create_agent(data)
    return APIResponse.ok(AgentResponse.model_validate(agent))
```

---

## ğŸ“ åŠ¨æ‰‹ç»ƒä¹ 

### ç»ƒä¹ ï¼šåˆ›å»ºéªŒè¯ä¾èµ–

```python
async def verify_agent_exists(
    agent_id: int,
    session: AsyncSession = Depends(get_db)
) -> Agent:
    """éªŒè¯ Agent å­˜åœ¨çš„ä¾èµ–"""
    agent = await session.get(Agent, agent_id)
    if agent is None:
        raise HTTPException(
            status_code=404,
            detail=f"Agent {agent_id} not found"
        )
    return agent

@router.get("/agents/{agent_id}/info")
async def get_agent_info(
    agent: Agent = Depends(verify_agent_exists)
):
    """Agent å·²ç»éªŒè¯å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨"""
    return {"name": agent.name}
```

---

## ğŸ“‹ ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ

| å®è·µ | è¯´æ˜ |
|------|------|
| å•ä¸€èŒè´£ | æ¯ä¸ªä¾èµ–åªåšä¸€ä»¶äº‹ |
| å‘½åæ¸…æ™° | `get_xxx` è¡¨ç¤ºè·å–ä¾èµ– |
| ä½¿ç”¨ç”Ÿæˆå™¨ | éœ€è¦æ¸…ç†èµ„æºæ—¶ä½¿ç”¨ `yield` |
| é¿å…æ·±å±‚åµŒå¥— | ä¾èµ–é“¾ä¸å®œè¿‡æ·± |
| åˆç†å¤ç”¨ | æå–å…¬å…±ä¾èµ– |

---

## ğŸ“ æœ¬è¯¾å°ç»“

| çŸ¥è¯†ç‚¹ | æŒæ¡ç¨‹åº¦ |
|--------|---------|
| ç†è§£ä¾èµ–æ³¨å…¥çš„æ¦‚å¿µ | â˜ |
| ä¼šä½¿ç”¨ Depends() | â˜ |
| ç†è§£ä¾èµ–é“¾çš„å·¥ä½œæ–¹å¼ | â˜ |
| ä¼šç¼–å†™ç”Ÿæˆå™¨ä¾èµ– | â˜ |
| ç†è§£ä¾èµ–çš„ç”Ÿå‘½å‘¨æœŸ | â˜ |

---

## ğŸ”œ ä¸‹ä¸€è¯¾é¢„å‘Š

**ç¬¬09è¯¾ï¼šRESTful API è·¯ç”±è®¾è®¡** - å­¦ä¹  RESTful API è®¾è®¡è§„èŒƒå’Œå®ç°ã€‚
