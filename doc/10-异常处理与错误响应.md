# ç¬¬10è¯¾ï¼šå¼‚å¸¸å¤„ç†ä¸é”™è¯¯å“åº”

## ğŸ¯ æœ¬è¯¾ç›®æ ‡

- ç†è§£è‡ªå®šä¹‰å¼‚å¸¸çš„è®¾è®¡
- å­¦ä¹ å…¨å±€å¼‚å¸¸å¤„ç†å™¨
- æŒæ¡ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼

---

## ğŸ“– ä¸ºä»€ä¹ˆéœ€è¦å¼‚å¸¸å¤„ç†ï¼Ÿ

### é—®é¢˜åœºæ™¯

```python
# æ²¡æœ‰å¼‚å¸¸å¤„ç†æ—¶ï¼Œé”™è¯¯ä¿¡æ¯æ‚ä¹±
{
    "detail": "string object has no attribute xxx"
}

# æœ‰ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œé”™è¯¯ä¿¡æ¯æ¸…æ™°
{
    "success": false,
    "data": null,
    "error": {
        "code": "NOT_FOUND",
        "message": "Agent with id 999 not found"
    }
}
```

### å¼‚å¸¸å¤„ç†çš„å¥½å¤„

| å¥½å¤„ | è¯´æ˜ |
|------|------|
| ç»Ÿä¸€æ ¼å¼ | æ‰€æœ‰é”™è¯¯å“åº”æ ¼å¼ä¸€è‡´ |
| å®‰å…¨æ€§ | éšè—æ•æ„Ÿçš„å†…éƒ¨é”™è¯¯ä¿¡æ¯ |
| å¯ç»´æŠ¤ | é›†ä¸­ç®¡ç†å¼‚å¸¸å¤„ç†é€»è¾‘ |
| å¯è¿½è¸ª | ä¾¿äºæ—¥å¿—è®°å½•å’Œé—®é¢˜æ’æŸ¥ |

---

## ğŸ” è‡ªå®šä¹‰å¼‚å¸¸ç±»

æŸ¥çœ‹ `app/main.py` ä¸­çš„å¼‚å¸¸å®šä¹‰ï¼š

### åŸºç¡€å¼‚å¸¸

```python
class NotFoundError(Exception):
    """èµ„æºæœªæ‰¾åˆ°å¼‚å¸¸"""
    def __init__(self, message: str = "Resource not found"):
        self.message = message
        super().__init__(self.message)

class ValidationError(Exception):
    """éªŒè¯é”™è¯¯å¼‚å¸¸"""
    def __init__(
        self, 
        message: str = "Validation failed", 
        details: dict | None = None
    ):
        self.message = message
        self.details = details or {}
        super().__init__(self.message)
```

### LLM ç›¸å…³å¼‚å¸¸

```python
class LLMError(Exception):
    """LLM API é”™è¯¯å¼‚å¸¸"""
    def __init__(self, message: str = "LLM API error"):
        self.message = message
        super().__init__(self.message)

class TimeoutError(Exception):
    """è¶…æ—¶å¼‚å¸¸"""
    def __init__(self, message: str = "Request timed out"):
        self.message = message
        super().__init__(self.message)
```

### æ•°æ®åº“å¼‚å¸¸

```python
class DatabaseError(Exception):
    """æ•°æ®åº“æ“ä½œå¼‚å¸¸"""
    def __init__(self, message: str = "Database operation failed"):
        self.message = message
        super().__init__(self.message)
```

---

## ğŸ“ å…¨å±€å¼‚å¸¸å¤„ç†å™¨

FastAPI å…è®¸æ³¨å†Œå…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼š

### 404 - èµ„æºæœªæ‰¾åˆ°

```python
@app.exception_handler(NotFoundError)
async def not_found_exception_handler(
    request: Request, 
    exc: NotFoundError
):
    """å¤„ç† 404 æœªæ‰¾åˆ°é”™è¯¯"""
    return JSONResponse(
        status_code=404,
        content={
            "success": False,
            "data": None,
            "error": {
                "code": "NOT_FOUND",
                "message": exc.message,
            },
        },
    )
```

### 422 - éªŒè¯é”™è¯¯

```python
@app.exception_handler(ValidationError)
async def validation_exception_handler(
    request: Request, 
    exc: ValidationError
):
    """å¤„ç†éªŒè¯é”™è¯¯"""
    return JSONResponse(
        status_code=422,
        content={
            "success": False,
            "data": None,
            "error": {
                "code": "VALIDATION_ERROR",
                "message": exc.message,
                "details": exc.details,
            },
        },
    )
```

### 502 - LLM API é”™è¯¯

```python
@app.exception_handler(LLMError)
async def llm_exception_handler(
    request: Request, 
    exc: LLMError
):
    """å¤„ç† LLM API é”™è¯¯"""
    return JSONResponse(
        status_code=502,
        content={
            "success": False,
            "data": None,
            "error": {
                "code": "LLM_ERROR",
                "message": exc.message,
            },
        },
    )
```

### 504 - è¶…æ—¶é”™è¯¯

```python
@app.exception_handler(TimeoutError)
async def timeout_exception_handler(
    request: Request, 
    exc: TimeoutError
):
    """å¤„ç†è¶…æ—¶é”™è¯¯"""
    return JSONResponse(
        status_code=504,
        content={
            "success": False,
            "data": None,
            "error": {
                "code": "TIMEOUT_ERROR",
                "message": exc.message,
            },
        },
    )
```

---

## ğŸ”„ å¼‚å¸¸å¤„ç†æµç¨‹

```
è¯·æ±‚åˆ°è¾¾
    â”‚
    â–¼
è·¯ç”±å‡½æ•°æ‰§è¡Œ
    â”‚
    â”œâ”€â”€ æ­£å¸¸å®Œæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è¿”å›æ­£å¸¸å“åº”
    â”‚
    â””â”€â”€ æŠ›å‡ºå¼‚å¸¸
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           FastAPI å¼‚å¸¸å¤„ç†å™¨åŒ¹é…              â”‚
    â”‚                                             â”‚
    â”‚   NotFoundError?     â†’ not_found_handler    â”‚
    â”‚   ValidationError?   â†’ validation_handler   â”‚
    â”‚   LLMError?          â†’ llm_handler          â”‚
    â”‚   HTTPException?     â†’ default_handler      â”‚
    â”‚   å…¶ä»–?              â†’ 500 å†…éƒ¨é”™è¯¯          â”‚
    â”‚                                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    è¿”å›ç»Ÿä¸€æ ¼å¼çš„é”™è¯¯å“åº”
```

---

## ğŸ“Š é”™è¯¯å“åº”ç¤ºä¾‹

### èµ„æºæœªæ‰¾åˆ°

```json
{
    "success": false,
    "data": null,
    "error": {
        "code": "NOT_FOUND",
        "message": "Agent with id 999 not found"
    }
}
```

### éªŒè¯å¤±è´¥

```json
{
    "success": false,
    "data": null,
    "error": {
        "code": "VALIDATION_ERROR",
        "message": "æ™ºèƒ½ä½“åç§°ä¸èƒ½ä¸ºç©º",
        "details": {
            "field": "name",
            "value": ""
        }
    }
}
```

### LLM é”™è¯¯

```json
{
    "success": false,
    "data": null,
    "error": {
        "code": "LLM_ERROR",
        "message": "API key is invalid"
    }
}
```

---

## ğŸ”§ è·¯ç”±ä¸­çš„å¼‚å¸¸å¤„ç†

ä¸¤ç§æ–¹å¼å¤„ç†å¼‚å¸¸ï¼š

### æ–¹å¼1ï¼šä½¿ç”¨ HTTPException

```python
from fastapi import HTTPException, status

@router.get("/{agent_id}")
async def get_agent(agent_id: int, service: AgentService):
    try:
        agent = await service.get_agent(agent_id)
        return APIResponse.ok(AgentResponse.model_validate(agent))
    except AgentNotFoundError:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail={
                "success": False,
                "data": None,
                "error": {
                    "code": "NOT_FOUND",
                    "message": f"Agent {agent_id} not found"
                }
            }
        )
```

### æ–¹å¼2ï¼šæŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ï¼ˆæ¨èï¼‰

```python
@router.get("/{agent_id}")
async def get_agent(agent_id: int, service: AgentService):
    try:
        agent = await service.get_agent(agent_id)
        return APIResponse.ok(AgentResponse.model_validate(agent))
    except AgentNotFoundError as e:
        # ç›´æ¥æŠ›å‡ºï¼Œç”±å…¨å±€å¤„ç†å™¨å¤„ç†
        raise NotFoundError(str(e))
```

---

## ğŸ“‹ HTTP çŠ¶æ€ç å¯¹ç…§è¡¨

| çŠ¶æ€ç  | åç§° | ä½¿ç”¨åœºæ™¯ |
|--------|------|---------|
| 200 | OK | è¯·æ±‚æˆåŠŸ |
| 201 | Created | èµ„æºåˆ›å»ºæˆåŠŸ |
| 400 | Bad Request | è¯·æ±‚æ ¼å¼é”™è¯¯ |
| 401 | Unauthorized | æœªè®¤è¯ |
| 403 | Forbidden | æ— æƒé™ |
| 404 | Not Found | èµ„æºä¸å­˜åœ¨ |
| 422 | Unprocessable | éªŒè¯å¤±è´¥ |
| 500 | Internal Error | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |
| 502 | Bad Gateway | ä¸Šæ¸¸æœåŠ¡é”™è¯¯ |
| 504 | Gateway Timeout | ä¸Šæ¸¸æœåŠ¡è¶…æ—¶ |

---

## ğŸ“ åŠ¨æ‰‹ç»ƒä¹ 

### ç»ƒä¹ ï¼šæ·»åŠ æƒé™é”™è¯¯å¤„ç†

```python
# 1. å®šä¹‰å¼‚å¸¸
class PermissionDeniedError(Exception):
    def __init__(self, message: str = "Permission denied"):
        self.message = message
        super().__init__(self.message)

# 2. æ³¨å†Œå¤„ç†å™¨
@app.exception_handler(PermissionDeniedError)
async def permission_denied_handler(request: Request, exc: PermissionDeniedError):
    return JSONResponse(
        status_code=403,
        content={
            "success": False,
            "data": None,
            "error": {
                "code": "PERMISSION_DENIED",
                "message": exc.message,
            },
        },
    )
```

---

## ğŸ“ æœ¬è¯¾å°ç»“

| çŸ¥è¯†ç‚¹ | æŒæ¡ç¨‹åº¦ |
|--------|---------|
| ç†è§£è‡ªå®šä¹‰å¼‚å¸¸çš„è®¾è®¡ | â˜ |
| ä¼šæ³¨å†Œå…¨å±€å¼‚å¸¸å¤„ç†å™¨ | â˜ |
| ç†è§£å¼‚å¸¸åˆ°å“åº”çš„è½¬æ¢ | â˜ |
| æŒæ¡ HTTP çŠ¶æ€ç ä½¿ç”¨ | â˜ |
| ä¼šè®¾è®¡ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼ | â˜ |

---

## ğŸ”œ ä¸‹ä¸€è¯¾é¢„å‘Š

**ç¬¬11è¯¾ï¼šç»Ÿä¸€å“åº”æ ¼å¼è®¾è®¡** - æ·±å…¥å­¦ä¹  API å“åº”çš„æ ‡å‡†åŒ–è®¾è®¡ã€‚
