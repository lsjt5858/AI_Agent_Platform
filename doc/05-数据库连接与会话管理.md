# ç¬¬05è¯¾ï¼šæ•°æ®åº“è¿æ¥ä¸ä¼šè¯ç®¡ç†

## ğŸ¯ æœ¬è¯¾ç›®æ ‡

- ç†è§£å¼‚æ­¥æ•°æ®åº“è¿æ¥çš„é…ç½®
- æŒæ¡ SQLAlchemy ä¼šè¯ç®¡ç†
- å­¦ä¹  FastAPI ä¸­çš„æ•°æ®åº“ä¾èµ–æ³¨å…¥

---

## ğŸ“– å¼‚æ­¥æ•°æ®åº“åŸºç¡€

### ä¸ºä»€ä¹ˆä½¿ç”¨å¼‚æ­¥ï¼Ÿ

| åŒæ­¥æ–¹å¼ | å¼‚æ­¥æ–¹å¼ |
|---------|---------|
| ä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªè¯·æ±‚ | å¯åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ |
| ç­‰å¾…æ•°æ®åº“æ—¶é˜»å¡ | ç­‰å¾…æ•°æ®åº“æ—¶å¯å¤„ç†å…¶ä»–è¯·æ±‚ |
| é€‚åˆä½å¹¶å‘ | é€‚åˆé«˜å¹¶å‘ |

### é¡¹ç›®ä½¿ç”¨çš„æ•°æ®åº“é©±åŠ¨

```
SQLite + aiosqlite = å¼‚æ­¥ SQLite
```

> ğŸ’¡ ç”Ÿäº§ç¯å¢ƒé€šå¸¸ä½¿ç”¨ PostgreSQL + asyncpg

---

## ğŸ” database.py è¯¦è§£

æŸ¥çœ‹ `app/database.py`ï¼š

### 1. å¯¼å…¥å¿…è¦æ¨¡å—

```python
from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine
from sqlalchemy.orm import DeclarativeBase

from .config import get_settings

settings = get_settings()
```

### 2. åˆ›å»ºå¼‚æ­¥å¼•æ“

```python
engine = create_async_engine(
    settings.database_url,    # æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
    echo=settings.debug,      # æ˜¯å¦æ‰“å° SQLï¼ˆè°ƒè¯•ç”¨ï¼‰
    future=True,              # ä½¿ç”¨ 2.0 é£æ ¼
)
```

**è¿æ¥å­—ç¬¦ä¸²æ ¼å¼**ï¼š
```
sqlite+aiosqlite:///./ai_agent.db
  â”‚      â”‚         â””â”€â”€ æ•°æ®åº“æ–‡ä»¶è·¯å¾„
  â”‚      â””â”€â”€ å¼‚æ­¥é©±åŠ¨
  â””â”€â”€ æ•°æ®åº“ç±»å‹
```

å…¶ä»–æ•°æ®åº“ç¤ºä¾‹ï¼š
```python
# PostgreSQL
"postgresql+asyncpg://user:pass@localhost/dbname"

# MySQL
"mysql+aiomysql://user:pass@localhost/dbname"
```

### 3. åˆ›å»ºä¼šè¯å·¥å‚

```python
async_session_maker = async_sessionmaker(
    engine,
    class_=AsyncSession,
    expire_on_commit=False,    # æäº¤åä¸è¿‡æœŸå¯¹è±¡
    autocommit=False,          # ä¸è‡ªåŠ¨æäº¤
    autoflush=False,           # ä¸è‡ªåŠ¨åˆ·æ–°
)
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | ä½œç”¨ |
|------|------|
| `expire_on_commit=False` | æäº¤åä»å¯è®¿é—®å¯¹è±¡å±æ€§ |
| `autocommit=False` | éœ€æ‰‹åŠ¨è°ƒç”¨ commit() |
| `autoflush=False` | éœ€æ‰‹åŠ¨è°ƒç”¨ flush() |

### 4. å®šä¹‰ Base ç±»

```python
class Base(DeclarativeBase):
    """æ‰€æœ‰ ORM æ¨¡å‹çš„åŸºç±»"""
    pass
```

æ‰€æœ‰æ¨¡å‹éƒ½ç»§æ‰¿è¿™ä¸ª Base ç±»ï¼š
```python
class Agent(Base):
    __tablename__ = "agents"
    ...
```

### 5. åˆå§‹åŒ–æ•°æ®åº“

```python
async def init_db() -> None:
    """åˆ›å»ºæ‰€æœ‰è¡¨"""
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
```

**å·¥ä½œåŸç†**ï¼š
1. `engine.begin()` å¼€å¯ä¸€ä¸ªäº‹åŠ¡
2. `run_sync` åœ¨å¼‚æ­¥ä¸Šä¸‹æ–‡ä¸­æ‰§è¡ŒåŒæ­¥æ“ä½œ
3. `create_all` æ ¹æ®æ¨¡å‹åˆ›å»ºè¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰

---

## ğŸ”§ æ•°æ®åº“ä¼šè¯ä¾èµ–

```python
async def get_db() -> AsyncSession:
    """
    æä¾›æ•°æ®åº“ä¼šè¯çš„ä¾èµ–å‡½æ•°ã€‚
    ç¡®ä¿æ­£ç¡®çš„äº‹åŠ¡ç®¡ç†å’Œèµ„æºæ¸…ç†ã€‚
    """
    async with async_session_maker() as session:
        try:
            yield session           # æä¾›ä¼šè¯ç»™è·¯ç”±ä½¿ç”¨
            await session.commit()  # æˆåŠŸåˆ™æäº¤
        except Exception:
            await session.rollback()  # å¤±è´¥åˆ™å›æ»š
            raise
        finally:
            await session.close()   # æœ€åå…³é—­ä¼šè¯
```

### äº‹åŠ¡ç®¡ç†æµç¨‹

```
è¯·æ±‚å¼€å§‹
    â”‚
    â–¼
åˆ›å»º Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                              â”‚
    â–¼                                              â”‚
yield session â”€â”€â”€â”€â”€â†’ è·¯ç”±å‡½æ•°ä½¿ç”¨ session          â”‚
    â”‚                     â”‚                        â”‚
    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                 â”‚
    â”‚              â–¼             â–¼                 â”‚
    â”‚          æˆåŠŸå®Œæˆ       å‘ç”Ÿå¼‚å¸¸              â”‚
    â”‚              â”‚             â”‚                 â”‚
    â”‚              â–¼             â–¼                 â”‚
    â”‚          commit()      rollback()            â”‚
    â”‚              â”‚             â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚             â”‚
                   â–¼             â–¼
                 close()      close()
                   â”‚             â”‚
                   â–¼             â–¼
              å“åº”æˆåŠŸ        å“åº”é”™è¯¯
```

---

## ğŸ“ åœ¨è·¯ç”±ä¸­ä½¿ç”¨æ•°æ®åº“

```python
from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession

from ..database import get_db

@router.get("/agents")
async def get_agents(
    session: AsyncSession = Depends(get_db)
):
    """ä½¿ç”¨ Depends æ³¨å…¥æ•°æ®åº“ä¼šè¯"""
    result = await session.execute(select(Agent))
    agents = result.scalars().all()
    return agents
```

### Depends å·¥ä½œåŸç†

```python
# Depends(get_db) çš„ä½œç”¨ï¼š
# 1. FastAPI è°ƒç”¨ get_db()
# 2. è·å– yield å‡ºçš„ session
# 3. å°† session ä¼ é€’ç»™è·¯ç”±å‡½æ•°å‚æ•°
# 4. è·¯ç”±å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œç»§ç»­æ‰§è¡Œ get_db() çš„ finally å—
```

---

## ğŸ”„ åº”ç”¨ç”Ÿå‘½å‘¨æœŸ

åœ¨ `main.py` ä¸­ï¼š

```python
from contextlib import asynccontextmanager

@asynccontextmanager
async def lifespan(app: FastAPI):
    """ç®¡ç†åº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶"""
    # === å¯åŠ¨æ—¶æ‰§è¡Œ ===
    await init_db()  # åˆ›å»ºæ•°æ®åº“è¡¨
    print("æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ")
    
    yield  # åº”ç”¨è¿è¡Œä¸­...
    
    # === å…³é—­æ—¶æ‰§è¡Œ ===
    print("åº”ç”¨å…³é—­")

app = FastAPI(lifespan=lifespan)
```

**ç”Ÿå‘½å‘¨æœŸæµç¨‹**ï¼š
```
uvicorn å¯åŠ¨
    â”‚
    â–¼
æ‰§è¡Œ lifespan (yield ä¹‹å‰)
    â”‚ - init_db()
    â”‚
    â–¼
yield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ åº”ç”¨è¿è¡Œï¼Œå¤„ç†è¯·æ±‚
    â”‚
    â–¼
æ‰§è¡Œ lifespan (yield ä¹‹å)
    â”‚ - æ¸…ç†èµ„æº
    â”‚
    â–¼
uvicorn å…³é—­
```

---

## ğŸ“ åŠ¨æ‰‹ç»ƒä¹ 

### ç»ƒä¹ ï¼šç†è§£ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```python
# é—®é¢˜ï¼šä»¥ä¸‹ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

@router.post("/agents")
async def create_agent(
    data: AgentCreate,
    session: AsyncSession = Depends(get_db)
):
    agent = Agent(name=data.name)
    session.add(agent)
    # æ³¨æ„ï¼šæ²¡æœ‰è°ƒç”¨ commit()
    return {"id": agent.id}
```

**ç­”æ¡ˆ**ï¼š
- ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `commit()`
- `get_db()` ä¾èµ–ä¼šåœ¨è·¯ç”±å‡½æ•°ç»“æŸåè‡ªåŠ¨ `commit()`
- å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œä¼šè‡ªåŠ¨ `rollback()`

---

## ğŸ“Š å¸¸ç”¨ä¼šè¯æ“ä½œ

| æ“ä½œ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| æ·»åŠ å¯¹è±¡ | `session.add(obj)` | æ ‡è®°ä¸ºå¾…æ’å…¥ |
| æ‰¹é‡æ·»åŠ  | `session.add_all([...])` | æ·»åŠ å¤šä¸ªå¯¹è±¡ |
| åˆ é™¤å¯¹è±¡ | `session.delete(obj)` | æ ‡è®°ä¸ºå¾…åˆ é™¤ |
| åˆ·æ–° | `await session.flush()` | æ‰§è¡Œ SQL ä½†ä¸æäº¤ |
| æäº¤ | `await session.commit()` | æäº¤äº‹åŠ¡ |
| å›æ»š | `await session.rollback()` | å›æ»šäº‹åŠ¡ |
| åˆ·æ–°å¯¹è±¡ | `await session.refresh(obj)` | é‡æ–°åŠ è½½å¯¹è±¡ |

---

## ğŸ“ æœ¬è¯¾å°ç»“

| çŸ¥è¯†ç‚¹ | æŒæ¡ç¨‹åº¦ |
|--------|---------|
| ç†è§£å¼‚æ­¥æ•°æ®åº“çš„ä¼˜åŠ¿ | â˜ |
| ä¼šé…ç½®å¼‚æ­¥å¼•æ“ | â˜ |
| ç†è§£ä¼šè¯å·¥å‚çš„ä½œç”¨ | â˜ |
| ç†è§£ get_db ä¾èµ–å‡½æ•° | â˜ |
| ç†è§£äº‹åŠ¡ç®¡ç†ï¼ˆcommit/rollbackï¼‰| â˜ |
| ç†è§£åº”ç”¨ç”Ÿå‘½å‘¨æœŸ | â˜ |

---

## ğŸ”œ ä¸‹ä¸€è¯¾é¢„å‘Š

**ç¬¬06è¯¾ï¼šRepository æ•°æ®è®¿é—®å±‚** - å­¦ä¹ å°è£…æ•°æ®åº“æ“ä½œçš„æœ€ä½³å®è·µã€‚
